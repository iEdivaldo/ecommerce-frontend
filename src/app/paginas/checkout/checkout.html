<div class="container mt-4">
  <h2 class="mb-4">Finalizar Pedido</h2>

  <!-- Barra de Progresso -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between">
        <div class="text-center" [class.text-primary]="etapaAtual() >= 1">
          <div class="rounded-circle bg-primary text-white d-inline-flex justify-content-center align-items-center" 
               style="width: 40px; height: 40px;">1</div>
          <div class="small mt-2">Endereço</div>
        </div>
        <div class="text-center" [class.text-primary]="etapaAtual() >= 2">
          <div class="rounded-circle d-inline-flex justify-content-center align-items-center" 
               [class.bg-primary]="etapaAtual() >= 2"
               [class.bg-secondary]="etapaAtual() < 2"
               [class.text-white]="etapaAtual() >= 2"
               style="width: 40px; height: 40px;">2</div>
          <div class="small mt-2">Pagamento</div>
        </div>
        <div class="text-center" [class.text-primary]="etapaAtual() >= 3">
          <div class="rounded-circle d-inline-flex justify-content-center align-items-center" 
               [class.bg-primary]="etapaAtual() >= 3"
               [class.bg-secondary]="etapaAtual() < 3"
               [class.text-white]="etapaAtual() >= 3"
               style="width: 40px; height: 40px;">3</div>
          <div class="small mt-2">Confirmação</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Etapa 1: Endereço -->
  @if (etapaAtual() === 1) {
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">Endereço de Entrega</h5>

        @if (endereco().length > 0) {
          <div class="mb-3">
            @for (end of endereco(); track end.id) {
              <div class="form-check mb-2">
                <input class="form-check-input" type="radio" 
                       [id]="'endereco-' + end.id"
                       [checked]="enderecoSelecionado()?.id === end.id"
                       (change)="selecionarEndereco(end)">
                <label class="form-check-label" [for]="'endereco-' + end.id">
                  {{ formatarEndereco(end) }}
                </label>
              </div>
            }
          </div>
        }

        <hr>

        <h6>Adicionar Novo Endereço</h6>
        <div class="row g-3">
          <div class="col-md-8">
            <input type="text" class="form-control" placeholder="Logradouro" [(ngModel)]="novoEndereco.logradouro">
          </div>
          <div class="col-md-4">
            <input type="text" class="form-control" placeholder="Número" [(ngModel)]="novoEndereco.numero">
          </div>
          <div class="col-md-6">
            <input type="text" class="form-control" placeholder="Complemento" [(ngModel)]="novoEndereco.complemento">
          </div>
          <div class="col-md-6">
            <input type="text" class="form-control" placeholder="Bairro" [(ngModel)]="novoEndereco.bairro">
          </div>
          <div class="col-md-5">
            <input type="text" class="form-control" placeholder="Cidade" [(ngModel)]="novoEndereco.cidade">
          </div>
          <div class="col-md-3">
            <input type="text" class="form-control" placeholder="Estado" [(ngModel)]="novoEndereco.estado" maxlength="2">
          </div>
          <div class="col-md-4">
            <input type="text" class="form-control" placeholder="CEP" [(ngModel)]="novoEndereco.cep">
          </div>
          <div class="col-12">
            <button class="btn btn-secondary" (click)="adicionarEndereco()">Adicionar Endereço</button>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- Etapa 2: Pagamento -->
  @if (etapaAtual() === 2) {
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">Método de Pagamento</h5>

        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" id="pix" value="PIX" [(ngModel)]="metodoPagamento">
          <label class="form-check-label" for="pix">PIX</label>
        </div>

        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" id="credito" value="CARTAO_CREDITO" [(ngModel)]="metodoPagamento">
          <label class="form-check-label" for="credito">Cartão de Crédito</label>
        </div>

        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" id="debito" value="CARTAO_DEBITO" [(ngModel)]="metodoPagamento">
          <label class="form-check-label" for="debito">Cartão de Débito</label>
        </div>

        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" id="boleto" value="BOLETO" [(ngModel)]="metodoPagamento">
          <label class="form-check-label" for="boleto">Boleto Bancário</label>
        </div>
      </div>
    </div>
  }

  <!-- Etapa 3: Confirmação -->
  @if (etapaAtual() === 3) {
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">Confirmação do Pedido</h5>

        <h6 class="mt-3">Endereço de Entrega:</h6>
        <p>{{ formatarEndereco(enderecoSelecionado()) }}</p>

        <h6 class="mt-3">Método de Pagamento:</h6>
        <p>{{ metodoPagamento() }}</p>

        <h6 class="mt-3">Itens do Pedido:</h6>
        @for (item of itensCarrinho(); track item.id) {
          <div class="d-flex justify-content-between mb-2">
            <span>{{ item.nomeProduto }} x{{ item.quantidade }}</span>
            <span>R$ {{ (item.precoProduto * item.quantidade).toFixed(2) }}</span>
          </div>
        }

        <hr>

        <div class="d-flex justify-content-between">
          <strong>Subtotal:</strong>
          <strong>R$ {{ total().toFixed(2) }}</strong>
        </div>
        <div class="d-flex justify-content-between">
          <strong>Frete:</strong>
          <strong>R$ {{ frete().toFixed(2) }}</strong>
        </div>
        <div class="d-flex justify-content-between mt-2">
          <h5>Total:</h5>
          <h5>R$ {{ totalComFrete().toFixed(2) }}</h5>
        </div>
      </div>
    </div>
  }

  <div class="d-flex justify-content-between mb-4">
      @if (etapaAtual() === 1) {
        <a class="btn btn-secondary" routerLink="/carrinho">
          ← Voltar ao Carrinho
        </a>
      } @else {
        <button class="btn btn-secondary" (click)="voltarEtapa()">
          Voltar
        </button>
      }

      @if (etapaAtual() < 3) {
        <button class="btn btn-primary" (click)="proximaEtapa()">
          Próximo
        </button>
      } @else {
        <button class="btn btn-success" (click)="finalizarPedido()" [disabled]="processandoPedido()">
          {{ processandoPedido() ? 'Processando...' : 'Finalizar Pedido' }}
        </button>
      }
  </div>
</div>